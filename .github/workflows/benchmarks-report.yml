name: "ğŸ… Benchmark Report"

on:
  workflow_run:
    workflows: ["ğŸ‡ Benchmarks"]
    types: ["completed"]
jobs:
  report:
    runs-on: ubuntu-latest
    if: >
      ${{ github.event.workflow_run.conclusion == 'success'
      && github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: dawidd6/action-download-artifact@v3
        with:
          workflow: benchmarks.yml
          name: benchmark-results

      - name: ğŸ“‘ Aggregate results
        run: >
          find .
          -name 'Tethos.Benchmarks.*.md'
          -exec cat {} \; 
          > results.md

      - name: ğŸ”Ÿ Resolve Pull Request Reference
        id: pr_number
        uses: juliangruber/read-file-action@v1
        with:
          path: pr_number.meta

      - name: ğŸ… Read test results
        uses: pCYSl5EDgo/cat@master
        id: benchmark
        with:
          path: results.md

      - name: ğŸ“¬ Find Comment
        uses: peter-evans/find-comment@v2
        id: fc
        with:
          issue-number: ${{ steps.pr_number.outputs.content }}
          comment-author: "github-actions[bot]"
          body-includes: ğŸ… Benchmark test report
          direction: last

      - name: ğŸ“ Create comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          body: |
            # ğŸ… Benchmark test report

            <details closed><summary>Expand to see results ğŸ”½</summary>

            ${{ steps.benchmark.outputs.text }}

            </details>
          issue-number: ${{ steps.pr_number.outputs.content }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: "replace"
