name: "ðŸŽ³ Stryker"

on:
  push:
    tags: ["v[1-9]+.[0-9]+.[0-9]"]
  pull_request:
    branches: ["main"]
    types: ["opened", "synchronize", "reopened"]

jobs:
  save-metadata:
    name: ðŸ”½ Save metadata
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: ðŸ”– Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: ðŸ”Ÿ Save Pull Request Number
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: echo $PR_NUMBER > pr_number.meta

      - name: ðŸ”Ÿ Save Branch Name
        run: echo ${{ steps.branch-name.outputs.current_branch }} | tr -d '\n' > branch.meta

      - name: ðŸ“š Test results
        uses: actions/upload-artifact@v4
        with:
          name: stryker-results-metadata
          path: "**/*.meta"

  mutation-tests:
    name: ðŸ’€ Tethos
    needs: save-metadata
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: ðŸ”§ Use .NET 8.0 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ðŸ”¦ Install Stryker
        run: dotnet tool install dotnet-stryker --version 3.* --global

      - name: ðŸ”– Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: ðŸ’€ Run mutation tests
        run: >
          is_tag=${{ steps.branch-name.outputs.is_tag }}
          target_branch=${{ steps.branch-name.outputs.current_branch }}
          extra_reporter="dashboard"

          if [ "$is_tag" = true ]; then
            target_branch="main"
          fi

          if [[ "$GITHUB_ACTOR" == "dependabot[bot]" ]]; then
            extra_reporter="cleartext"
          fi

          cd test/Tethos.Tests

          dotnet stryker --config-file stryker-config.json
          --version "$target_branch"
          --reporter "$extra_reporter"
          --reporter "cleartext"
          --reporter "html"
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

      - name: ðŸ“š Test results
        uses: actions/upload-artifact@v4
        with:
          name: stryker-results
          path: "**/StrykerOutput/**"

  mutation-tests-moq:
    name: ðŸ’€ Tethos.Moq
    needs: save-metadata
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: ðŸ”§ Use .NET 8.0 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ðŸ”¦ Install Stryker
        run: dotnet tool install dotnet-stryker --version 3.* --global

      - name: ðŸ”– Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: ðŸ’€ Run mutation tests
        run: >
          is_tag=${{ steps.branch-name.outputs.is_tag }}
          target_branch=${{ steps.branch-name.outputs.current_branch }}
          extra_reporter="dashboard"

          if [ "$is_tag" = true ]; then
            target_branch="main"
          fi

          if [[ "$GITHUB_ACTOR" == "dependabot[bot]" ]]; then
            extra_reporter="cleartext"
          fi

          cd test/Tethos.Moq.Tests

          dotnet stryker --config-file stryker-config.json
          --version "$target_branch"
          --reporter "$extra_reporter"
          --reporter "cleartext"
          --reporter "html"
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

      - name: ðŸ“š Test results
        uses: actions/upload-artifact@v4
        with:
          name: stryker-results-moq
          path: "**/StrykerOutput/**"

  mutation-tests-fakeiteasy:
    name: ðŸ’€ Tethos.FakeItEasy
    needs: save-metadata
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: ðŸ”§ Use .NET 8.0 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ðŸ”¦ Install Stryker
        run: dotnet tool install dotnet-stryker --version 3.* --global

      - name: ðŸ”– Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: ðŸ’€ Run mutation tests
        run: >
          is_tag=${{ steps.branch-name.outputs.is_tag }}
          target_branch=${{ steps.branch-name.outputs.current_branch }}
          extra_reporter="dashboard"

          if [ "$is_tag" = true ]; then
            target_branch="main"
          fi

          if [[ "$GITHUB_ACTOR" == "dependabot[bot]" ]]; then
            extra_reporter="cleartext"
          fi

          cd test/Tethos.FakeItEasy.Tests

          dotnet stryker --config-file stryker-config.json
          --version "$target_branch"
          --reporter "$extra_reporter"
          --reporter "cleartext"
          --reporter "html"
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

      - name: ðŸ“š Test results
        uses: actions/upload-artifact@v4
        with:
          name: stryker-results-fakeiteasy
          path: "**/StrykerOutput/**"

  mutation-tests-nsubstitute:
    name: ðŸ’€ Tethos.NSubstitute
    needs: save-metadata
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@a5ac7e51b41094c92402da3b24376905380afc29 # v4

      - name: ðŸ”§ Use .NET 8.0 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: ðŸ”¦ Install Stryker
        run: dotnet tool install dotnet-stryker --version 3.* --global

      - name: ðŸ”– Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v8

      - name: ðŸ’€ Run mutation tests
        run: >
          is_tag=${{ steps.branch-name.outputs.is_tag }}
          target_branch=${{ steps.branch-name.outputs.current_branch }}
          extra_reporter="dashboard"

          if [ "$is_tag" = true ]; then
            target_branch="main"
          fi

          if [[ "$GITHUB_ACTOR" == "dependabot[bot]" ]]; then
            extra_reporter="cleartext"
          fi

          cd test/Tethos.NSubstitute.Tests

          dotnet stryker --config-file stryker-config.json
          --version "$target_branch"
          --reporter "$extra_reporter"
          --reporter "cleartext"
          --reporter "html"
        env:
          STRYKER_DASHBOARD_API_KEY: ${{ secrets.STRYKER_DASHBOARD_API_KEY }}

      - name: ðŸ“š Test results
        uses: actions/upload-artifact@v4
        with:
          name: stryker-results-nsubstitute
          path: "**/StrykerOutput/**"
