name: "ğŸ‡ Benchmarks"

on:
  push:
    tags: ["v[1-9]+.[0-9]+.[0-9]"]
  pull_request:
    branches: ["main"]
    types: ["opened", "synchronize", "reopened"]

jobs:
  run-benchmarks:
    name: ğŸ„ Benchmarks
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ”§ Use .NET Core 6.0 SDK
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 6.0.x

      - name: ğŸ”¬ Test
        run: "dotnet run
          --project ./test/Tethos.Benchmarks/\
          Tethos.Benchmarks.csproj
          --configuration Release"

      - name: ğŸ“‘ Aggregate results
        run: >
          find .
          -name 'Tethos.Benchmarks.*.md'
          -exec cat {} \; 
          > results.md

      - name: ğŸ… Read test results
        uses: pCYSl5EDgo/cat@master
        id: benchmark
        with:
          path: results.md

      - name: ğŸ“¬ Find Comment
        uses: peter-evans/find-comment@v1
        id: fc
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: ğŸ… Benchmark test report
          direction: last

      - name: ğŸ“ Create comment
        uses: peter-evans/create-or-update-comment@v1
        with:
          body: |
            # ğŸ… Benchmark test report

            <details closed><summary>Expand to see results ğŸ”½</summary>

            ${{ steps.benchmark.outputs.text }}

            </details>
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: "replace"
